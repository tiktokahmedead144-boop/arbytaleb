<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ù„ØºØªÙŠ Ù‡ÙˆÙŠØªÙŠ - Ø§Ù„Ø·Ø§Ù„Ø¨</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root { 
            --main: #4a90e2; --sec: #2ecc71; --vocab: #9b59b6; 
            --video: #e67e22; --err: #e74c3c; --bg: #f4f7f6; 
            --white: #ffffff; --text: #2d3436; 
        }

        * { box-sizing: border-box; transition: 0.3s; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden; user-select: none; }

        .swal2-popup { border-radius: 25px !important; font-family: 'Cairo', sans-serif !important; }
        .swal2-styled.swal2-confirm { background-color: var(--main) !important; border-radius: 12px !important; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ø¯ÙŠØ« */
        #update-banner {
            display: none; background: #e74c3c; color: white; 
            text-align: center; padding: 12px; font-weight: bold; 
            position: sticky; top: 0; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #update-banner a { color: #fff; background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 8px; text-decoration: none; margin-right: 10px; border: 1px solid white; }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
        .container { 
            width: 100%; max-width: 950px; background: var(--white); 
            min-height: 100vh; padding: 20px; margin: 0 auto; 
            box-shadow: 0 0 20px rgba(0,0,0,0.05); padding-bottom: 80px;
        }
        @media (min-width: 768px) {
            .container { border-radius: 30px; margin: 20px auto; min-height: auto; padding: 30px; }
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header-brand { text-align: center; margin-bottom: 25px; }
        .header-brand img { width: 90px; margin-bottom: 10px; animation: float 3s ease-in-out infinite; }
        .header-brand h1 { font-size: 1.8rem; margin: 0; color: var(--main); font-weight: 900; }
        .header-brand p { color: #888; margin: 5px 0 0; font-size: 0.9rem; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        /* Ø§Ù„ØªÙˆØ§ØµÙ„ */
        .social-bar { display: flex; justify-content: center; gap: 20px; margin: 20px 0; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .social-bar a { font-size: 28px; text-decoration: none; display: none; cursor: pointer; }
        .social-bar a:hover { transform: scale(1.2); }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… */
        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; outline: none; background: #f8fafc; }
        input:focus, select:focus { border-color: var(--main); background: #fff; }

        .btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; font-size: 16px; color: white; }
        .btn:active { transform: scale(0.98); }
        .btn-main { background: linear-gradient(135deg, #4a90e2, #2563eb); box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3); }
        .btn-outline { background: #fff; border: 2px solid #e2e8f0; color: #64748b; }
        .btn-video { background: linear-gradient(135deg, #e67e22, #c2410c); box-shadow: 0 4px 15px rgba(230, 126, 34, 0.3); }

        /* Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„ÙƒØ±ÙˆØª */
        .grid-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        @media (min-width: 600px) { .grid-cards { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } }
        .card { background: #fff; border: 2px solid #f1f5f9; border-radius: 24px; padding: 25px 15px; text-align: center; cursor: pointer; border-bottom: 5px solid #cbd5e1; position: relative; overflow: hidden; }
        .card:active { border-bottom-width: 2px; transform: translateY(3px); }
        .card i { font-size: 35px; margin-bottom: 15px; display: block; color: var(--main); }
        .card b { display: block; font-size: 1.1rem; color: #334155; }

        /* ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± */
        #q-timer { font-size: 28px; font-weight: 900; color: var(--err); background: #fff; padding: 5px 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .prog-bg { width:100%; height:10px; background:#e2e8f0; border-radius:10px; margin: 15px 0; overflow:hidden; }
        #timer-bar { width:100%; height:100%; background:var(--main); transition: width 1s linear; }
        #q-box { background: #f8fafc; padding: 30px 20px; border-radius: 20px; text-align: center; margin-bottom: 25px; border: 2px solid #e2e8f0; }
        #q-text { margin: 0; line-height: 1.6; font-size: 1.2rem; color: #334155; }
        #q-options { display: grid; grid-template-columns: 1fr; gap: 12px; }
        #q-options button { text-align: right; padding-right: 20px; border-width: 2px; font-weight: 600; font-size: 1.1rem; }
        #q-rule { background: #fff9db; padding: 20px; border-radius: 16px; margin-top: 20px; border-right: 6px solid #fcc419; line-height: 1.6; display: none; }

        /* Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ */
        .grade-group { margin-bottom: 30px; }
        .grade-title { background: #fff; color: var(--main); padding: 10px 25px; border-radius: 50px; font-weight: 900; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; border: 2px solid #e2e8f0; display: inline-block; }
        .lesson-card { background: #fff; border-radius: 18px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f1f5f9; border-right: 5px solid var(--sec); box-shadow: 0 2px 10px rgba(0,0,0,0.02); cursor: pointer; }
        .lesson-info { display: flex; align-items: center; gap: 15px; }
        .lesson-icon-box { width: 45px; height: 45px; background: #f0fdf4; color: var(--sec); border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        .lesson-text h4 { margin: 0; font-size: 16px; font-weight: 700; color: #334155; }
        .lesson-text span { font-size: 12px; color: #94a3b8; }
        .lesson-btn { background: var(--bg); color: var(--main); width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99999; justify-content: center; align-items: center; padding: 15px; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 100%; max-width: 750px; border-radius: 25px; padding: 25px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from {transform: translateY(50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        #view-bod { font-size: 18px; line-height: 1.8; color: #333; background: #fefefe; padding: 15px; border-radius: 15px; border: 1px dashed #ccc; margin-top: 15px; white-space: pre-wrap; }
        
        #global-loader { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98); z-index: 20000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid var(--main); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #countdown-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.92); z-index: 30000; justify-content: center; align-items: center; }
        #countdown-text { font-size: 8rem; font-weight: 900; color: #fff; text-shadow: 0 0 30px var(--main); animation: popEffect 0.9s infinite; }
        @keyframes popEffect { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
    </style>
</head>
<body>
    <div id="update-banner"> <span id="update-msg"></span> <a id="update-link" href="#" target="_blank">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù†</a> </div>
    
    <div id="global-loader"> 
        <div class="spinner"></div> 
        <div class="loader-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</div> 
    </div>
    
    <div id="countdown-overlay"> <div id="countdown-text"></div> </div>
    
    <audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>
    <audio id="sound-beep" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sound-go" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <div class="container">
        <div id="page-home">
            <div class="header-brand">
                <img id="disp-logo" src="https://cdn-icons-png.flaticon.com/512/3426/3426653.png">
                <h1 id="disp-title">Ù…Ù†ØµØ© Ù„ØºØªÙŠ Ù‡ÙˆÙŠØªÙŠ</h1>
                <p id="disp-subtitle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
            <div class="social-bar"> 
                <a id="link-tele" onclick="openExternalLink(this)" style="color:#0088cc;"><i class="fab fa-telegram"></i></a> 
                <a id="link-tiktok" onclick="openExternalLink(this)"><i class="fab fa-tiktok"></i></a> 
                <a id="link-wa" onclick="openExternalLink(this)" style="color:#25d366;"><i class="fab fa-whatsapp"></i></a> 
                <a id="link-face" onclick="openExternalLink(this)" style="color:#1877f2;"><i class="fab fa-facebook"></i></a> 
            </div>
            <div style="background: #fff; padding: 20px; border-radius: 20px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                <label><b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:</b></label>
                <input type="text" id="std-name" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
                <select id="std-grade">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ --</option>
                    <optgroup label="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ"><option value="4">Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option></optgroup>
                    <optgroup label="Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ"><option value="7">Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option></optgroup>
                </select>
            </div>
            <div class="grid-cards">
                <div class="card" onclick="openSection('grammar')"> <i class="fas fa-magic"></i><b>Ø±ÙˆØ§Ø¦Ø¹ Ø§Ù„Ù†Ø­Ùˆ</b> </div>
                <div class="card" onclick="openSection('vocab')"> <i class="fas fa-language"></i><b>Ù‚Ø§Ù…ÙˆØ³Ù†Ø§</b> </div>
                <div class="card" onclick="openLibrary()"> <i class="fas fa-book-reader"></i><b>Ø§Ù„Ù…ÙƒØªØ¨Ø©</b> </div>
                <div class="card" onclick="openVideos()"> <i class="fas fa-video"></i><b>Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</b> </div>
            </div>
        </div>

        <div id="page-periods" style="display: none;">
            <h2 id="period-title" style="text-align: center; color: var(--main);"></h2>
            <div class="grid-cards">
                <div class="card" onclick="startQuiz('Ø´Ø§Ù…Ù„')"> <i class="fas fa-globe"></i><b>Ø´Ø§Ù…Ù„</b> </div>
                <div class="card" onclick="startQuiz('ØªØ±Ù…1')"> <i class="fas fa-book"></i><b>Ø§Ù„ØªØ±Ù… 1</b> </div>
                <div class="card" onclick="startQuiz('ØªØ±Ù…2')"> <i class="fas fa-book-open"></i><b>Ø§Ù„ØªØ±Ù… 2</b> </div>
            </div>
            <div id="month-grid" class="grid-cards"></div>
            <button class="btn btn-outline" onclick="goBack('page-home')">Ø¹ÙˆØ¯Ø©</button>
        </div>

        <div id="page-quiz" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn-outline" style="width:auto; padding:5px 15px; border-radius: 8px;" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
                <span id="q-count" style="font-weight: bold; color: var(--main);"></span>
                <span id="q-timer">30</span>
            </div>
            <div class="prog-bg"><div id="timer-bar"></div></div>
            <div id="q-box">
                <h3 id="q-text"></h3>
            </div>
            <div id="q-options"></div>
            <div id="q-rule">
                <b>ğŸ’¡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©:</b>
                <p id="rule-text" style="margin:5px 0 0;"></p>
            </div>
            <button id="btn-next" class="btn btn-main" style="display: none; margin-top: 20px;">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-chevron-left"></i></button>
        </div>

        <div id="page-library" style="display: none;">
            <h2 style="text-align: center; color: var(--main);">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ğŸ“š</h2>
            <div id="lib-content"></div>
            <button class="btn btn-outline" onclick="goBack('page-home')">Ø¹ÙˆØ¯Ø©</button>
        </div>

        <div id="page-videos" style="display: none;">
            <h2 style="text-align: center; color: var(--video);">Ø´Ø±ÙˆØ­Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ğŸ¬</h2>
            <div id="vid-content"></div>
            <button class="btn btn-outline" onclick="goBack('page-home')">Ø¹ÙˆØ¯Ø©</button>
        </div>

        <div id="page-result" style="display: none; text-align: center;">
            <h2 id="res-score" style="font-size: 32px; color: var(--main);"></h2>
            <div id="certificate" style="border: 15px double #d4af37; padding: 40px 20px; background: #fff; margin: 20px 0; border-radius: 10px;">
                <h1 style="color:#d4af37; margin:0;">Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±</h1>
                <p id="cert-teacher-txt">ÙŠÙ…Ù†Ø­ Ø§Ù„Ø£Ø³ØªØ§Ø° ... Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„Ø·Ø§Ù„Ø¨/Ø©:</p>
                <h2 id="cert-name" style="border-bottom: 2px solid #d4af37; display: inline-block; padding: 0 30px; margin: 10px 0;"></h2>
                <p>Ù„ØªØ­Ù‚ÙŠÙ‚Ù‡ Ø¯Ø±Ø¬Ø§Øª Ù…ØªÙ…ÙŠØ²Ø© ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.</p>
            </div>
            <button class="btn btn-main" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="btn btn-outline" onclick="location.reload()">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </div>

    <div id="modal-view" class="modal">
        <div class="modal-content">
            <span onclick="document.getElementById('modal-view').style.display='none'" style="float:left; cursor:pointer; font-size:35px;">Ã—</span>
            <h2 id="view-tit"></h2>
            <div id="view-bod"></div>
            <img id="view-img" style="display:none; width:100%; margin-top:15px; border-radius:15px;">
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Compat Version)
        const firebaseConfig = {
            apiKey: "AIzaSyCgpj7MLByWpTVUE2Tg3DQ0pwsUjLhAyEM",
            authDomain: "ahmedead-5185c.firebaseapp.com",
            projectId: "ahmedead-5185c",
            storageBucket: "ahmedead-5185c.firebasestorage.app",
            messagingSenderId: "559908876854",
            appId: "1:559908876854:web:e8e7c151e984dc13219e97"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        function showLoader() { document.getElementById('global-loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('global-loader').style.display = 'none'; }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        function loadSiteConfig() {
            showLoader();
            // Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ«
            db.collection("settings").doc("app_config").get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if(data.download_url) document.getElementById('update-link').href = data.download_url;
                    if(data.show_banner) {
                        document.getElementById('update-banner').style.display = 'block';
                        document.getElementById('update-msg').innerText = data.update_msg || "ÙŠÙˆØ¬Ø¯ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯!";
                    }
                }
            }).catch(console.error);

            // Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
            db.collection("settings").doc("site_info").get().then((doc) => {
                let welcomeMsg = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ù„ØºØªÙŠ Ù‡ÙˆÙŠØªÙŠ";
                if (doc.exists) {
                    const info = doc.data();
                    if(info.title) { document.title = info.title; document.getElementById('disp-title').innerText = info.title; }
                    if(info.subtitle) {
                        document.getElementById('disp-subtitle').innerText = info.subtitle;
                        const teacherName = info.subtitle.includes('Ù…Ø¹') ? info.subtitle.split('Ù…Ø¹')[1] : "Ø§Ù„Ø£Ø³ØªØ§Ø°";
                        document.getElementById('cert-teacher-txt').innerText = `ÙŠÙ…Ù†Ø­ ${teacherName} Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„Ø·Ø§Ù„Ø¨/Ø©:`;
                    }
                    if(info.logo) document.getElementById('disp-logo').src = info.logo;
                    if(info.welcome) welcomeMsg = info.welcome;

                    const updateLink = (id, url) => {
                        const el = document.getElementById(id);
                        if(url) {
                            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙŠÙØªØ­ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                            if(id === 'link-wa' && !url.includes('http')) url = `https://wa.me/20${url.replace(/^0+/, '')}`;
                            el.setAttribute('data-url', url); 
                            el.style.display = 'inline-block';
                        }
                    };
                    updateLink('link-wa', info.wa); updateLink('link-tele', info.tele);
                    updateLink('link-face', info.face); updateLink('link-tiktok', info.tiktok);
                }
                
                hideLoader();
                setTimeout(() => {
                    Swal.fire({
                        title: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„! ğŸš€',
                        text: welcomeMsg,
                        imageUrl: document.getElementById('disp-logo').src,
                        imageWidth: 80, imageHeight: 80,
                        confirmButtonText: 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©',
                        padding: '2em', backdrop: `rgba(0,0,123,0.4)`
                    });
                }, 500);

            }).catch((e) => {
                console.error(e);
                hideLoader();
                Swal.fire('Ø®Ø·Ø£', 'ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
            });
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        window.onload = loadSiteConfig;

        // Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠ
        function openExternalLink(element) {
            const url = element.getAttribute('data-url');
            if(url) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ø¬Ù‡Ø© Android
                if (typeof android !== 'undefined' && android.openUrl) {
                    android.openUrl(url);
                } else {
                    window.open(url, '_system');
                }
            }
        }

        // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
        function goBack(id) {
            document.querySelectorAll('.container > div').forEach(d => d.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            window.scrollTo(0,0);
        }

        let questions = [], curIdx = 0, score = 0, timer, timeLeft = 30, currentSection = '';
        const months = ["Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„"];
        const gradeNames = { "4": "Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "5": "Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "6": "Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "7": "Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "8": "Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "9": "Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ" };

        function openSection(type) {
            const grade = document.getElementById('std-grade').value;
            const name = document.getElementById('std-name').value;
            if(!name || !grade) return Swal.fire({icon: 'warning', text: 'ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ Ø£ÙˆÙ„Ø§Ù‹'});
            
            currentSection = type;
            goBack('page-periods');
            document.getElementById('period-title').innerText = `Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ${type === 'grammar' ? 'Ø§Ù„Ù†Ø­Ùˆ' : 'Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª'}`;
            document.getElementById('month-grid').innerHTML = months.map(m => `<div class="card" onclick="startQuiz('${m}')"><b>${m}</b></div>`).join('');
        }

        function startQuiz(period) {
            showLoader();
            const grade = document.getElementById('std-grade').value;
            let qry;

            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ§ÙÙ‚ÙŠØ© (Compat)
            let collectionRef = db.collection("questions");
            let finalQuery;

            if(period === 'Ø´Ø§Ù…Ù„') {
                finalQuery = collectionRef.where("grade", "==", grade).where("type", "==", currentSection);
            } else {
                finalQuery = collectionRef.where("grade", "==", grade).where("type", "==", currentSection).where("month", "==", period);
            }
            
            finalQuery.get().then((querySnapshot) => {
                questions = querySnapshot.docs.map(d => ({id: d.id, ...d.data()})).sort(() => Math.random() - 0.5);
                
                hideLoader();
                if(!questions.length) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….', 'info');
                
                curIdx = 0; score = 0;
                
                document.getElementById('countdown-overlay').style.display = 'flex';
                let count = 3;
                const txt = document.getElementById('countdown-text');
                
                // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†
                const beep = document.getElementById('sound-beep');
                const go = document.getElementById('sound-go');

                const interval = setInterval(() => {
                    txt.innerText = count > 0 ? count : "Ø§Ù†Ø·Ù„Ù‚!";
                    if(count > 0) {
                        if(beep) beep.play().catch(e=>{});
                    } else {
                        if(go) go.play().catch(e=>{});
                        clearInterval(interval);
                        setTimeout(() => {
                            document.getElementById('countdown-overlay').style.display = 'none';
                            goBack('page-quiz'); showQuestion();
                        }, 1000);
                    }
                    count--;
                }, 1000);

            }).catch((error) => {
                console.error("Error getting documents: ", error);
                hideLoader();
                Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', 'error');
            });
        }

        function showQuestion() {
            if(curIdx >= questions.length) return endQuiz();
            
            clearInterval(timer); timeLeft = 30; updateTimer();
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('q-rule').style.display = 'none';
            
            const q = questions[curIdx];
            document.getElementById('q-count').innerText = `Ø³Ø¤Ø§Ù„ ${curIdx+1} / ${questions.length}`;
            document.getElementById('q-text').innerText = q.q;
            
            let opts = [q.c, ...q.w].sort(() => Math.random() - 0.5);
            document.getElementById('q-options').innerHTML = opts.map(o => `<button class="btn btn-outline" style="text-align:right;" onclick="checkAnswer(this, '${o}')">${o}</button>`).join('');
            
            timer = setInterval(() => { timeLeft--; updateTimer(); if(timeLeft <= 0) checkAnswer(null, ''); }, 1000);
        }

        function checkAnswer(btn, val) {
            clearInterval(timer);
            const q = questions[curIdx];
            document.querySelectorAll('#q-options button').forEach(b => b.style.pointerEvents = 'none');
            
            if(val === q.c) {
                score++; 
                const s = document.getElementById('sound-correct'); if(s) s.play().catch(e=>{});
                if(btn) { btn.style.background = "#2ecc71"; btn.style.color = "#fff"; }
            } else {
                const s = document.getElementById('sound-wrong'); if(s) s.play().catch(e=>{});
                if(btn) { btn.style.background = "#e74c3c"; btn.style.color = "#fff"; }
                document.querySelectorAll('#q-options button').forEach(b => { if(b.innerText === q.c) { b.style.background = "#2ecc71"; b.style.color = "#fff"; } });
            }
            
            if(q.rule) { document.getElementById('rule-text').innerText = q.rule; document.getElementById('q-rule').style.display = 'block'; }
            document.getElementById('btn-next').style.display = 'block';
        }

        document.getElementById('btn-next').onclick = () => { curIdx++; showQuestion(); };
        function updateTimer() { document.getElementById('timer-bar').style.width = (timeLeft/30)*100 + "%"; document.getElementById('q-timer').innerText = timeLeft; }

        function endQuiz() {
            goBack('page-result');
            const percentage = (score / questions.length) * 100;
            document.getElementById('res-score').innerText = `Ø¯Ø±Ø¬ØªÙƒ: ${score} Ù…Ù† ${questions.length}`;
            
            // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            db.collection("results").add({
                name: document.getElementById('std-name').value,
                grade: document.getElementById('std-grade').value,
                score: score, total: questions.length,
                date: new Date().toLocaleString('ar-EG'),
                examType: document.getElementById('period-title').innerText
            }).catch(e => console.log(e));

            if(percentage >= 70) {
                document.getElementById('certificate').style.display = 'block';
                document.getElementById('cert-name').innerText = document.getElementById('std-name').value;
                confetti({ particleCount: 150, spread: 70 });
            } else document.getElementById('certificate').style.display = 'none';
        }

        function openLibrary() {
            showLoader();
            goBack('page-library');
            db.collection("lessons").get().then((querySnapshot) => {
                const container = document.getElementById('lib-content');
                container.innerHTML = '';
                let grps = {};
                querySnapshot.forEach((doc) => {
                    const l = doc.data();
                    if(!grps[l.grade]) grps[l.grade] = [];
                    grps[l.grade].push(l);
                });
                
                if(Object.keys(grps).length === 0) container.innerHTML = '<p style="text-align:center">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©</p>';
                
                for(let g in grps) {
                    let div = document.createElement('div'); div.className = 'grade-group';
                    div.innerHTML = `<div class="grade-title"><i class="fas fa-user-graduate"></i> ${gradeNames[g]}</div>`;
                    grps[g].forEach(lesson => {
                        let card = document.createElement('div'); card.className = 'lesson-card';
                        card.innerHTML = `<div class="lesson-info"><div class="lesson-icon-box"><i class="fas fa-book"></i></div><div class="lesson-text"><h4>${lesson.title}</h4><span>Ø§Ø¶ØºØ· Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©</span></div></div><div class="lesson-btn"><i class="fas fa-chevron-left"></i></div>`;
                        card.onclick = () => {
                            document.getElementById('view-tit').innerText = lesson.title;
                            document.getElementById('view-bod').innerText = lesson.body;
                            const imgElem = document.getElementById('view-img');
                            if(lesson.img) { imgElem.src = lesson.img; imgElem.style.display = 'block'; } else { imgElem.style.display = 'none'; }
                            document.getElementById('modal-view').style.display = 'flex';
                        };
                        div.appendChild(card);
                    });
                    container.appendChild(div);
                }
                hideLoader();
            }).catch(e => {
                console.error(e);
                hideLoader();
            });
        }

        function openVideos() {
            showLoader();
            goBack('page-videos');
            db.collection("videos").get().then((querySnapshot) => {
                let html = '';
                querySnapshot.forEach((doc) => {
                    const v = doc.data();
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
                    let videoId = "";
                    if(v.url.includes('v=')) videoId = v.url.split('v=')[1].split('&')[0];
                    else if(v.url.includes('youtu.be/')) videoId = v.url.split('youtu.be/')[1];
                    
                    let link = videoId ? 
                        `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen style="border-radius:15px;"></iframe>` : 
                        `<a onclick="window.open('${v.url}', '_system')" class="btn btn-video">Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>`;
                    
                    html += `<div class="grade-group" style="padding:15px; background:white; border-radius:15px; margin-bottom:15px;"><h3 style="margin-top:0;">${v.title} (${gradeNames[v.grade]})</h3>${link}</div>`;
                });
                document.getElementById('vid-content').innerHTML = html || '<p style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</p>';
                hideLoader();
            }).catch(e => {
                console.error(e);
                hideLoader();
            });
        }
    </script>

</body></html>