<!doctype html>
<html lang="ar" dir="rtl"> 
 <head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
  <title>Ù…Ù†ØµØ© Ù„ØºØªÙŠ Ù‡ÙˆÙŠØªÙŠ</title> 
  <meta name="mobile-web-app-capable" content="yes"> 
  <meta name="theme-color" content="#4a90e2"> 
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&amp;display=swap" rel="stylesheet"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"> 
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> 
  <style>
        :root { 
            --main: #4a90e2; --sec: #2ecc71; --vocab: #9b59b6; 
            --video: #e67e22; --err: #e74c3c; --bg: #f4f7f6; 
            --white: #ffffff; --text: #2d3436; 
        }

        * { box-sizing: border-box; transition: 0.3s; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden; user-select: none; }

        #global-loader { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 1); z-index: 20000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--main); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f7f6; z-index: 15000; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; animation: fadeInDown 0.5s; }
        .auth-tabs { display: flex; background: #f1f5f9; padding: 5px; border-radius: 15px; margin-bottom: 20px; }
        .auth-tabs button { flex: 1; padding: 10px; border: none; background: none; border-radius: 10px; font-weight: bold; color: #64748b; cursor: pointer; }
        .auth-tabs button.active { background: white; color: var(--main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .container { width: 100%; max-width: 800px; background: var(--white); min-height: 100vh; padding: 20px; margin: 0 auto; padding-bottom: 80px; }
        @media (min-width: 768px) { .container { border-radius: 30px; margin: 20px auto; min-height: auto; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); } }

        .header-brand { text-align: center; margin-bottom: 20px; margin-top: 10px; }
        .header-brand img { width: 85px; margin-bottom: 5px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .header-brand h1 { font-size: 1.7rem; margin: 0; color: var(--main); font-weight: 800; }
        .social-bar { display: flex; justify-content: center; gap: 18px; margin: 15px 0; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .social-bar a { font-size: 26px; text-decoration: none; color: var(--text); display: none; cursor: pointer; }

        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; font-size: 15px; color: white; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.97); box-shadow: none; }
        .btn-main { background: linear-gradient(135deg, #4a90e2, #2563eb); }
        .btn-sec { background: linear-gradient(135deg, #2ecc71, #219150); }
        .btn-video { background: linear-gradient(135deg, #e67e22, #c2410c); }
        .btn-outline { background: #fff; border: 2px solid #e2e8f0; color: #64748b; box-shadow: none; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 14px; outline: none; background: #fafafa; }
        input:focus, select:focus, textarea:focus { border-color: var(--main); background: #fff; }

        .grid-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        @media (min-width: 600px) { .grid-cards { grid-template-columns: repeat(4, 1fr); } }
        .card { background: #fff; border: 1px solid #f1f5f9; border-radius: 18px; padding: 15px 10px; text-align: center; cursor: pointer; border-bottom: 4px solid #cbd5e1; }
        .card:active { border-bottom-width: 1px; transform: translateY(3px); }
        .card i { font-size: 28px; margin-bottom: 8px; display: block; color: var(--main); }
        .card b { display: block; font-size: 0.95rem; color: #333; }

        .post-card { background: white; border: 1px solid #eee; border-radius: 15px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .post-header { padding: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f9f9f9; }
        .post-avatar { width: 40px; height: 40px; background: #e67e22; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }
        .post-body { padding: 15px; white-space: pre-wrap; line-height: 1.6; color: #444; }
        .post-img { width: 100%; max-height: 300px; object-fit: cover; }
        .post-attachment { background: #f0f9ff; padding: 10px; margin: 10px 15px; border-radius: 10px; border: 1px solid #bae6fd; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: 0.2s; }
        .post-attachment:active { background: #e0f2fe; }
        .post-actions { padding: 10px 15px; border-top: 1px solid #eee; display: flex; gap: 10px; color: #666; font-size: 13px; }
        .comment-box { padding: 10px; background: #fafafa; display: none; }

        .profile-header { text-align: center; background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 20px; border-radius: 20px; margin-bottom: 20px; position: relative; }
        .avatar-circle { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin: 0 auto 10px; font-size: 35px; color: var(--main); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stats-row { display: flex; justify-content: space-around; margin-top: 15px; }
        .stat-val { display: block; font-size: 1.2rem; font-weight: 900; color: var(--main); }
        
        .lib-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .lib-item { background: white; border-radius: 15px; padding: 12px; display: flex; align-items: center; gap: 12px; border: 1px solid #eee; cursor: pointer; border-right: 4px solid var(--sec); }
        .lib-icon { width: 45px; height: 45px; background: #f0fdf4; border-radius: 12px; display: flex; justify-content: center; align-items: center; color: var(--sec); font-size: 20px; }
        .exam-item { background: white; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background: white; width: 100%; max-width: 700px; border-radius: 20px; padding: 20px; max-height: 90vh; overflow-y: auto; }
    </style> 
 </head> 
 <body> 
  <div id="global-loader"><div class="spinner"></div></div> 

  <div id="auth-overlay"> 
   <div class="auth-box animate__animated animate__fadeInDown"> 
    <img src="https://cdn-icons-png.flaticon.com/512/3426/3426653.png" width="80" style="margin-bottom:15px"> 
    <h2 style="color:var(--main); margin:0 0 20px; font-size:1.5rem;">Ù…Ù†ØµØ© Ù„ØºØªÙŠ Ù‡ÙˆÙŠØªÙŠ</h2> 
    <div class="auth-tabs"> 
        <button class="active" onclick="switchAuth('login')">Ø¯Ø®ÙˆÙ„</button> 
        <button onclick="switchAuth('register')">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button> 
    </div> 
    <div id="form-login"> 
     <input type="email" id="log-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"> 
     <input type="password" id="log-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"> <button class="btn btn-main" onclick="userLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button> 
    </div> 
    <div id="form-register" style="display:none;"> 
     <input type="text" id="reg-name" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ"> 
     <select id="reg-grade"> 
        <option value="">-- Ø§Ø®ØªØ± ØµÙÙƒ --</option> 
        <optgroup label="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ"><option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option></optgroup> 
        <optgroup label="Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ"><option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option></optgroup> 
     </select> 
     <input type="email" id="reg-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"> 
     <input type="password" id="reg-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"> <button class="btn btn-sec" onclick="userRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button> 
    </div> 
    <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;"> 
        <button class="btn btn-outline" onclick="showGuestForm()">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±</button> 
    </div> 
    <div id="guest-form-area" style="display:none;" class="animate__animated animate__fadeIn"> 
     <h4 style="margin:0 0 10px; color:#555;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø§Ø¦Ø± (Ù„Ù„Ø´Ù‡Ø§Ø¯Ø©)</h4> 
     <input type="text" id="guest-name" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ"> 
     <select id="guest-grade"> 
        <option value="">-- Ø§Ø®ØªØ± ØµÙÙƒ --</option> 
        <option value="4">4 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="5">5 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="6">6 Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option> 
        <option value="7">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="8">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option><option value="9">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option> 
     </select> 
     <button class="btn btn-main" onclick="guestLoginConfirm()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†</button> 
    </div> 
   </div> 
  </div> 

  <audio id="sound-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio> 
  <audio id="sound-wrong" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio> 

  <div class="container" id="main-container" style="display:none;"> 
   
   <div id="page-home"> 
    <div class="header-brand"> 
     <img id="disp-logo" src="https://cdn-icons-png.flaticon.com/512/3426/3426653.png"> 
     <h1 id="disp-title">Ù…Ù†ØµØ© Ù„ØºØªÙŠ Ù‡ÙˆÙŠØªÙŠ</h1> 
     <div id="disp-desc" style="color: #636e72; font-size: 14px; margin-top: 10px; white-space: pre-line;"></div> 
    </div> 
    <div class="social-bar"> 
        <a id="link-tele" onclick="openLink(this)"><i class="fab fa-telegram"></i></a> 
        <a id="link-tiktok" onclick="openLink(this)"><i class="fab fa-tiktok"></i></a> 
        <a id="link-wa" onclick="openLink(this)" style="color:#25d366;"><i class="fab fa-whatsapp"></i></a> 
        <a id="link-face" onclick="openLink(this)" style="color:#1877f2;"><i class="fab fa-facebook"></i></a> 
    </div> 
    <div style="background: #fff; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0; margin-bottom: 20px;"> 
     <div style="display:flex; justify-content:space-between; align-items:center;"> 
      <div style="display:flex; align-items:center; gap:10px;"> 
       <div style="width:40px; height:40px; background:#e0f2fe; border-radius:50%; display:flex; justify-content:center; align-items:center; color:var(--main);"><i class="fas fa-user"></i></div> 
       <div> <b id="home-name-disp">Ø²Ø§Ø¦Ø±</b> <span id="home-grade-disp" style="display:block; font-size:12px; color:#888;">--</span> </div> 
      </div> <button class="btn btn-outline" style="width:auto; padding:5px 15px; font-size:12px; margin:0;" onclick="openProfile()">Ù…Ù„ÙÙŠ <i class="fas fa-chevron-left"></i></button> 
     </div> 
    </div> 
    <div class="card" onclick="openPostsPage()" style="margin-bottom:20px; border-bottom-color: #e67e22; background: #fff8f0; grid-column: span 2;"> 
        <i class="fas fa-bullhorn" style="color: #e67e22;"></i> <b>Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</b> 
        <p style="margin:5px 0 0; font-size:12px; color:#777;">ØªØ§Ø¨Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©</p> 
    </div> 
    <div class="grid-cards"> 
     <div class="card" onclick="openSection('grammar')"> <i class="fas fa-magic"></i><b>Ø§Ù„Ù†Ø­Ùˆ</b> </div> 
     <div class="card" onclick="openSection('vocab')"> <i class="fas fa-language"></i><b>Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª</b> </div> 
     <div class="card" onclick="openLibrary()"> <i class="fas fa-book-reader"></i><b>Ø§Ù„Ù…ÙƒØªØ¨Ø©</b> </div> 
     <div class="card" onclick="openVideos()"> <i class="fas fa-video"></i><b>Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</b> </div> 
     <div class="card" onclick="openComments()" style="border-bottom-color:#9b59b6;"> <i class="fas fa-comments" style="color:#9b59b6;"></i><b>Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</b> </div> 
    </div> 
   </div> 

   <div id="page-posts" style="display:none;"> 
    <h2 style="text-align:center; color:#e67e22;">ğŸ“¢ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</h2> 
    <div id="posts-container" style="padding-bottom:20px;"></div> 
    <button class="btn btn-outline" onclick="goBack('page-home')">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button> 
   </div> 

   <div id="page-profile" style="display:none;"> 
    <h2 style="text-align:center; color:var(--main);">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ğŸ‘¤</h2> 
    <div class="profile-header"> 
     <button onclick="toggleEditMode()" style="position:absolute; left:15px; top:15px; background:white; border:none; width:30px; height:30px; border-radius:50%;"><i class="fas fa-pen"></i></button> 
     <div class="avatar-circle"><i class="fas fa-user-graduate"></i></div> 
     <div id="view-mode"> 
      <h3 id="prof-name"></h3> <span id="prof-grade" style="background:white; padding:3px 10px; border-radius:10px; font-size:12px; color:#666;"></span> 
     </div> 
     <div id="edit-mode" style="display:none; margin-top:10px;"> 
      <input type="text" id="edit-name" placeholder="Ø§Ù„Ø§Ø³Ù…"> 
      <select id="edit-grade"> <option value="4">4</option><option value="5">5</option><option value="6">6</option> <option value="7">7</option><option value="8">8</option><option value="9">9</option> </select> 
      <button class="btn btn-main" style="padding:5px;" onclick="saveProfileData()">Ø­ÙØ¸</button> 
     </div> 
     <div class="stats-row"> 
      <div class="stat-item"> <span class="stat-val" id="st-exams">0</span><span>Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</span> </div> 
      <div class="stat-item"> <span class="stat-val" id="st-badges">0</span><span>Ø´Ø§Ø±Ø§Øª</span> </div> 
      <div class="stat-item"> <span class="stat-val" id="st-score">0%</span><span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span> </div> 
     </div> 
    </div> 
    <h3 style="font-size:16px;">ğŸ† Ø­Ù‚ÙŠØ¨Ø© Ø§Ù„Ø´Ø§Ø±Ø§Øª:</h3> 
    <div id="badges-container" class="grid-cards" style="grid-template-columns: repeat(4, 1fr);"></div> 
    <h3 style="font-size:16px;">ğŸ’¬ Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø¹Ù„Ù…:</h3> 
    <div style="background:#fff; border:1px solid #eee; border-radius:15px; padding:10px;"> 
     <div id="chat-messages" style="height:200px; overflow-y:auto; border-bottom:1px solid #eee; margin-bottom:10px; display:flex; flex-direction:column; gap:8px;"></div> 
     <div style="display:flex; gap:5px;"> 
      <input type="text" id="msg-input" placeholder="Ø±Ø³Ø§Ù„ØªÙƒ..." style="margin:0;"> 
      <button onclick="sendPrivateMessage()" style="width:50px; background:var(--main); color:white; border:none; border-radius:12px;"><i class="fas fa-paper-plane"></i></button> 
     </div> 
    </div> 
    <button class="btn btn-outline" onclick="goBack('page-home')" style="margin-top:20px;">Ø¹ÙˆØ¯Ø©</button> 
    <button class="btn btn-outline" onclick="auth.signOut().then(()=>location.reload())" style="color:var(--err); border-color:var(--err);">Ø®Ø±ÙˆØ¬</button> 
   </div> 

   <div id="page-periods" style="display: none;"> 
    <h2 id="period-title" style="text-align: center; color: var(--main); margin-bottom:20px;"></h2> 
    <div class="grid-cards"> 
     <div class="card" onclick="openExamCategory('Ø£Ø³Ø¨ÙˆØ¹ÙŠ')"> <i class="fas fa-calendar-week"></i><b>Ø£Ø³Ø¨ÙˆØ¹ÙŠ</b> </div> 
     <div class="card" onclick="openExamCategory('Ø´Ø§Ù…Ù„')"> <i class="fas fa-globe"></i><b>Ø´Ø§Ù…Ù„</b> </div> 
     <div class="card" onclick="openExamCategory('ØªØ±Ù…1')"> <i class="fas fa-book"></i><b>ØªØ±Ù… 1</b> </div> 
     <div class="card" onclick="openExamCategory('ØªØ±Ù…2')"> <i class="fas fa-book-open"></i><b>ØªØ±Ù… 2</b> </div> 
    </div> 
    <h3 style="margin:10px 0; font-size:15px;">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</h3> 
    <div id="month-grid" class="grid-cards"></div> 
    <button class="btn btn-outline" onclick="goBack('page-home')">Ø¹ÙˆØ¯Ø©</button> 
   </div> 

   <div id="page-exam-list" style="display:none;"> 
    <h3 id="exam-list-title" style="text-align:center; color:var(--main);"></h3> 
    <div id="exams-container" style="display:flex; flex-direction:column; gap:10px;"></div> 
    <p id="no-exams-msg" style="text-align:center; display:none; color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª.</p> 
    <button class="btn btn-outline" onclick="goBack('page-periods')" style="margin-top:20px;">Ø±Ø¬ÙˆØ¹</button> 
   </div> 

   <div id="page-quiz" style="display: none;"> 
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;"> 
        <button class="btn-outline" style="width:auto; padding:5px 12px; font-size:13px;" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button> 
        <span id="q-count" style="font-weight: bold; color: var(--main);"></span> 
        <span id="q-timer" style="font-size:24px; font-weight:900; color:#e74c3c;">30</span> 
    </div> 
    <div style="width:100%; height:8px; background:#eee; border-radius:10px; margin: 15px 0; overflow:hidden;"> 
     <div id="timer-bar" style="width:100%; height:100%; background:var(--main); transition:1s linear;"></div> 
    </div> 
    <div id="q-box" style="background:#f8fafc; padding:20px; border-radius:15px; text-align:center; margin-bottom:15px; border:1px solid #e2e8f0;"> 
     <h3 id="q-text" style="margin:0; font-size:1.1rem; line-height:1.6;"></h3> 
    </div> 
    <div id="q-options" style="display: grid; grid-template-columns: 1fr; gap: 10px;"></div> 
    <button id="btn-next" class="btn btn-main" style="display: none; margin-top: 20px;">Ø§Ù„ØªØ§Ù„ÙŠ</button> 
   </div> 

   <div id="page-library" style="display: none;"> 
    <h2 style="text-align: center; color: var(--main);">Ø§Ù„Ù…ÙƒØªØ¨Ø© ğŸ“š</h2> 
    <div id="lib-content" class="lib-grid"></div> 
    <button class="btn btn-outline" onclick="goBack('page-home')">Ø¹ÙˆØ¯Ø©</button> 
   </div> 

   <div id="page-videos" style="display: none;"> 
    <h2 style="text-align: center; color: var(--video);">Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ğŸ¬</h2> 
    <div id="vid-content" class="lib-grid"></div> 
    <button class="btn btn-outline" onclick="goBack('page-home')">Ø¹ÙˆØ¯Ø©</button> 
   </div> 

   <div id="page-comments" style="display: none;"> 
    <h2 style="text-align: center; color: #9b59b6;">Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ø¹Ø§Ù… ğŸŒ</h2> 
    <div style="background:white; padding:15px; border-radius:15px; margin-bottom:15px; border:1px solid #eee;"> 
        <textarea id="pub-comment" rows="2" placeholder="Ø´Ø§Ø±ÙƒÙ†Ø§ Ø±Ø£ÙŠÙƒ..."></textarea> 
        <button class="btn btn-main" onclick="sendPublicComment()" style="margin-top:5px;">Ù†Ø´Ø±</button> 
    </div> 
    <div id="pub-list"></div> 
    <button class="btn btn-outline" onclick="goBack('page-home')">Ø¹ÙˆØ¯Ø©</button> 
   </div> 

   <div id="page-result" style="display: none; text-align: center;"> 
    <h2 id="res-score" style="font-size: 30px; color: var(--main);"></h2> 
    <div id="certificate" style="border: 10px double #d4af37; padding: 30px 15px; background: #fff; margin: 20px 0; border-radius: 10px; display:none;"> 
     <h1 style="color:#d4af37; margin:0;">Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±</h1> 
     <p>ØªÙ…Ù†Ø­ Ù…Ù†ØµØ© Ù„ØºØªÙŠ Ù‡ÙˆÙŠØªÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„Ø·Ø§Ù„Ø¨/Ø©:</p> 
     <h2 id="cert-name" style="border-bottom: 2px solid #d4af37; display: inline-block; padding: 0 20px; margin: 10px 0;"></h2> 
     <p>Ù„ØªÙÙˆÙ‚Ù‡ ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</p> 
    </div> 
    <button class="btn btn-main" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button> 
    <button class="btn btn-outline" onclick="location.reload()">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button> 
   </div> 

   <div id="modal-view" class="modal"> 
    <div class="modal-content"> 
     <span onclick="document.getElementById('modal-view').style.display='none'" style="float:left; cursor:pointer; font-size:35px; color:#999;">Ã—</span> 
     <h2 id="view-tit" style="font-size:1.2rem;"></h2> 
     <div id="view-bod" style="white-space: pre-wrap; font-size:15px; line-height:1.7;"></div> 
     <img id="view-img" style="display:none; width:100%; margin-top:15px; border-radius:10px;"> 
    </div> 
   </div> 

   <script>
        // ØªÙƒÙˆÙŠÙ† ÙØ§ÙŠØ±Ø¨ÙŠØ² Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyCgpj7MLByWpTVUE2Tg3DQ0pwsUjLhAyEM",
            authDomain: "ahmedead-5185c.firebaseapp.com",
            projectId: "ahmedead-5185c",
            storageBucket: "ahmedead-5185c.firebasestorage.app",
            messagingSenderId: "559908876854",
            appId: "1:559908876854:web:e8e7c151e984dc13219e97"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null; 
        let userData = { name: "Ø²Ø§Ø¦Ø±", grade: "" };
        const gradeNames = { "4": "Ø±Ø§Ø¨Ø¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "5": "Ø®Ø§Ù…Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "6": "Ø³Ø§Ø¯Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "7": "Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "8": "Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "9": "Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ" };

        function showLoader() { document.getElementById('global-loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('global-loader').style.display = 'none'; }

        // --- AUTH ---
        function switchAuth(type) {
            document.querySelectorAll('.auth-tabs button').forEach(b => b.classList.remove('active')); event.target.classList.add('active');
            if(type === 'login') { document.getElementById('form-login').style.display = 'block'; document.getElementById('form-register').style.display = 'none'; }
            else { document.getElementById('form-login').style.display = 'none'; document.getElementById('form-register').style.display = 'block'; }
            document.getElementById('guest-form-area').style.display='none';
        }

        function userRegister() {
            const n = document.getElementById('reg-name').value; const g = document.getElementById('reg-grade').value; const e = document.getElementById('reg-email').value; const p = document.getElementById('reg-pass').value;
            if(!n || !g || !e || !p) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'warning');
            showLoader(); auth.createUserWithEmailAndPassword(e, p).then((cred) => {
                return db.collection('users').doc(cred.user.uid).set({ name: n, grade: g, email: e, joinDate: new Date().toISOString() });
            }).then(() => location.reload()).catch((err) => { hideLoader(); Swal.fire('Ø®Ø·Ø£', err.message, 'error'); });
        }
        function userLogin() {
            const e = document.getElementById('log-email').value; const p = document.getElementById('log-pass').value;
            showLoader(); auth.signInWithEmailAndPassword(e, p).catch(() => { hideLoader(); Swal.fire('Ø®Ø·Ø£', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©', 'error'); });
        }
        function showGuestForm() { document.getElementById('form-login').style.display='none'; document.getElementById('form-register').style.display='none'; document.getElementById('guest-form-area').style.display='block'; }
        function guestLoginConfirm(){
            const n = document.getElementById('guest-name').value; const g = document.getElementById('guest-grade').value;
            if(!n || !g) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
            userData = { name: n, grade: g, isGuest: true };
            document.getElementById('auth-overlay').style.display='none'; document.getElementById('main-container').style.display='block'; updateUI();
        }

        auth.onAuthStateChanged((user) => {
            hideLoader();
            if (user) {
                currentUser = user; document.getElementById('auth-overlay').style.display = 'none'; document.getElementById('main-container').style.display = 'block';
                db.collection('users').doc(user.uid).onSnapshot((doc) => { if(doc.exists) { userData = doc.data(); userData.isGuest = false; updateUI(); } });
            }
        });

        function updateUI(){
            document.getElementById('home-name-disp').innerText = userData.name; document.getElementById('home-grade-disp').innerText = gradeNames[userData.grade] || userData.grade;
            document.getElementById('prof-name').innerText = userData.name; document.getElementById('prof-grade').innerText = gradeNames[userData.grade] || userData.grade;
            db.collection("settings").doc("site_info").get().then(doc => { if(doc.exists) { const info = doc.data(); if(info.title) document.getElementById('disp-title').innerText = info.title; if(info.logo) document.getElementById('disp-logo').src = info.logo; if(info.description) document.getElementById('disp-desc').innerText = info.description; const setLink = (id, url) => { const el = document.getElementById(id); if(url) { if(id === 'link-wa' && !url.includes('http')) url = `https://wa.me/20${url.replace(/^0+/, '')}`; el.setAttribute('data-url', url); el.style.display = 'inline-block'; } }; setLink('link-wa', info.wa); setLink('link-tele', info.tele); setLink('link-face', info.face); setLink('link-tiktok', info.tiktok); } }).catch(()=>{});
        }
        function openLink(el) { const url = el.getAttribute('data-url'); if(url) window.open(url, '_system'); }
        function goBack(id) { document.querySelectorAll('.container > div').forEach(d => d.style.display = 'none'); document.getElementById(id).style.display = 'block'; window.scrollTo(0,0); }

        // --- TEACHER POSTS ---
        function openPostsPage(){
            goBack('page-posts');
            const cont = document.getElementById('posts-container');
            cont.innerHTML = '<div class="spinner" style="margin:20px auto;"></div>';
            db.collection('posts').orderBy('date', 'desc').limit(20).get().then(snap => {
                cont.innerHTML = '';
                if(snap.empty) { cont.innerHTML = '<p style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>'; return; }
                snap.forEach(doc => {
                    const p = doc.data();
                    let attachHTML = '';
                    if(p.attachType === 'exam') {
                        attachHTML = `<div class="post-attachment" onclick="startExamDirect('${p.attachId}')">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <i class="fas fa-file-alt" style="color:#e67e22; font-size:24px;"></i>
                                <div><b>Ø§Ø¶ØºØ· Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</b><br><small style="color:#888;">Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±ÙÙ‚</small></div>
                            </div><i class="fas fa-chevron-left" style="color:#aaa;"></i></div>`;
                    } else if (p.attachType === 'lesson') {
                        attachHTML = `<div class="post-attachment" onclick="openLessonDirect('${p.attachId}')">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <i class="fas fa-book" style="color:#2ecc71; font-size:24px;"></i>
                                <div><b>Ø§Ø¶ØºØ· Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¯Ø±Ø³</b><br><small style="color:#888;">Ø¯Ø±Ø³ Ù…Ø±ÙÙ‚</small></div>
                            </div><i class="fas fa-chevron-left" style="color:#aaa;"></i></div>`;
                    }

                    cont.innerHTML += `
                    <div class="post-card animate__animated animate__fadeInUp">
                        <div class="post-header">
                            <div class="post-avatar"><i class="fas fa-user-tie"></i></div>
                            <div><b>Ø§Ù„Ù…Ø¹Ù„Ù…</b><br><small style="color:#888">${new Date(p.date).toLocaleDateString('ar-EG')}</small></div>
                        </div>
                        <div class="post-body">${p.title ? `<h3 style="margin:0 0 8px; color:#222;">${p.title}</h3>` : ''}${p.body}</div>
                        ${p.img ? `<img src="${p.img}" class="post-img">` : ''}
                        ${attachHTML}
                        <div class="post-actions">
                            <span onclick="toggleComments('${doc.id}')" style="cursor:pointer;"><i class="far fa-comment"></i> ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
                        </div>
                        <div id="comments-${doc.id}" class="comment-box">
                            <div id="clist-${doc.id}" style="margin-bottom:10px;"></div>
                            <div style="display:flex; gap:5px;">
                                <input id="cinp-${doc.id}" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." style="margin:0;">
                                <button class="btn btn-main" style="width:auto; margin:0; padding:5px 15px;" onclick="addPostComment('${doc.id}')">Ø¥Ø±Ø³Ø§Ù„</button>
                            </div>
                        </div>
                    </div>`;
                });
            });
        }
        function toggleComments(pid){
            const box = document.getElementById(`comments-${pid}`);
            if(box.style.display === 'block') { box.style.display = 'none'; return; }
            box.style.display = 'block';
            db.collection('posts').doc(pid).collection('comments').orderBy('time').onSnapshot(snap=>{
                document.getElementById(`clist-${pid}`).innerHTML = snap.docs.map(d=>`
                    <div style="background:white; padding:8px; border-radius:10px; margin-bottom:5px; font-size:13px; border:1px solid #eee;">
                        <b>${d.data().name}:</b> ${d.data().text}
                        ${d.data().reply ? `<div style="background:#f0fdf4; border-right:3px solid #2ecc71; padding:5px; margin-top:5px; color:#27ae60;">ğŸ‘¨â€ğŸ« <b>Ø±Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…:</b> ${d.data().reply}</div>` : ''}
                    </div>
                `).join('');
            });
        }
        function addPostComment(pid){
            const txt = document.getElementById(`cinp-${pid}`).value; if(!txt) return;
            db.collection('posts').doc(pid).collection('comments').add({ name: userData.name, text: txt, time: new Date().toISOString() });
            document.getElementById(`cinp-${pid}`).value = '';
        }
        function openLessonDirect(lid) {
            showLoader();
            db.collection('lessons').doc(lid).get().then(doc => {
                hideLoader();
                if(!doc.exists) return Swal.fire('Ø¹ÙÙˆØ§Ù‹', 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù…ØªØ§Ø­', 'error');
                const item = doc.data();
                document.getElementById('view-tit').innerText = item.title;
                document.getElementById('view-bod').innerText = item.body;
                const img = document.getElementById('view-img');
                if(item.img && item.img.length>5) { img.src=item.img; img.style.display='block'; } else { img.style.display='none'; }
                document.getElementById('modal-view').style.display = 'flex';
            });
        }

        // --- Exams System ---
        let currentQuestions=[], curIdx=0, score=0, timer, timeLeft=30;
        const months = ["Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„"];

        function openSection(type) {
            window.currentSubject = type; goBack('page-periods');
            document.getElementById('period-title').innerText = type === 'grammar' ? 'Ø§Ù„Ù†Ø­Ùˆ' : 'Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª';
            document.getElementById('month-grid').innerHTML = months.map(m => `<div class="card" onclick="openExamCategory('${m}')"><b>${m}</b></div>`).join('');
        }
        function openExamCategory(cat){
            goBack('page-exam-list'); document.getElementById('exam-list-title').innerText = `Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: ${cat}`;
            const cont = document.getElementById('exams-container'); cont.innerHTML = '<div class="spinner" style="margin:auto;"></div>';
            
            // ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (all) Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„ØµÙ Ø§Ù„Ø·Ø§Ù„Ø¨
            db.collection('exams').where('subject', '==', window.currentSubject).where('category', '==', cat).where('grade', 'in', [userData.grade, 'all']).get().then(snap => {
                  cont.innerHTML = '';
                  if(snap.empty) { document.getElementById('no-exams-msg').style.display='block'; return; }
                  document.getElementById('no-exams-msg').style.display='none';
                  snap.forEach(doc => {
                      const exam = doc.data();
                      const div = document.createElement('div'); div.className = 'exam-item animate__animated animate__fadeInRight';
                      div.innerHTML = `<div><b>${exam.title}</b> ${exam.grade === 'all' ? '<span style="font-size:10px; background:var(--err); color:white; padding:2px 5px; border-radius:5px; margin-right:5px;">Ø¹Ø§Ù…</span>':''}</div> <i class="fas fa-chevron-left" style="color:#ccc;"></i>`;
                      div.onclick = () => startSpecificExam(doc.id, exam.title);
                      cont.appendChild(div);
                  });
            });
        }
        function startExamDirect(eid) { 
            db.collection('exams').doc(eid).get().then(d => {
                if(d.exists) startSpecificExam(eid, d.data().title);
                else Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
            });
        }
        function startSpecificExam(examId, title){
            document.getElementById('global-loader').style.display='flex';
            db.collection('questions').where('examId', '==', examId).get().then(snap => {
                document.getElementById('global-loader').style.display='none';
                currentQuestions = snap.docs.map(d => d.data());
                if(currentQuestions.length === 0) return Swal.fire('Ø¹ÙÙˆØ§Ù‹', 'Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯', 'info');
                currentQuestions.sort(() => Math.random() - 0.5); curIdx = 0; score = 0; window.currentExamTitle = title;
                goBack('page-quiz'); showQuestion();
            });
        }
        function showQuestion() {
            if(curIdx >= currentQuestions.length) return endQuiz();
            clearInterval(timer); timeLeft = 30; updateTimer();
            document.getElementById('btn-next').style.display = 'none';
            const q = currentQuestions[curIdx];
            document.getElementById('q-count').innerText = `${curIdx+1}/${currentQuestions.length}`;
            document.getElementById('q-text').innerText = q.q;
            let opts = [q.c, ...q.w].sort(() => Math.random() - 0.5);
            document.getElementById('q-options').innerHTML = opts.map(o => `<button class="btn btn-outline" style="text-align:right;" onclick="checkAnswer(this, '${o}')">${o}</button>`).join('');
            timer = setInterval(() => { timeLeft--; updateTimer(); if(timeLeft <= 0) checkAnswer(null, ''); }, 1000);
        }
        function checkAnswer(btn, val) {
            clearInterval(timer); const q = currentQuestions[curIdx];
            document.querySelectorAll('#q-options button').forEach(b => b.style.pointerEvents = 'none');
            if(val === q.c) { score++; document.getElementById('sound-correct').play().catch(e=>{}); if(btn) { btn.style.background = "#2ecc71"; btn.style.color = "#fff"; } } 
            else { document.getElementById('sound-wrong').play().catch(e=>{}); if(btn) { btn.style.background = "#e74c3c"; btn.style.color = "#fff"; } document.querySelectorAll('#q-options button').forEach(b => { if(b.innerText === q.c) { b.style.background = "#2ecc71"; b.style.color = "#fff"; } }); }
            document.getElementById('btn-next').style.display = 'block';
        }
        document.getElementById('btn-next').onclick = () => { curIdx++; showQuestion(); };
        function updateTimer() { document.getElementById('timer-bar').style.width = (timeLeft/30)*100 + "%"; document.getElementById('q-timer').innerText = timeLeft; }
        function endQuiz() {
            goBack('page-result'); const percentage = (score / currentQuestions.length) * 100;
            document.getElementById('res-score').innerText = `Ø§Ù„Ø¯Ø±Ø¬Ø©: ${score} Ù…Ù† ${currentQuestions.length}`;
            if(!userData.isGuest) { db.collection("results").add({ uid: currentUser.uid, name: userData.name, grade: userData.grade, score: score, total: currentQuestions.length, date: new Date().toISOString(), examType: window.currentExamTitle }).then(()=> checkAutoBadges()); }
            if(percentage >= 70) { document.getElementById('certificate').style.display = 'block'; document.getElementById('cert-name').innerText = userData.name; confetti({ particleCount: 150, spread: 70 }); } else document.getElementById('certificate').style.display = 'none';
        }

        // --- Library & Videos ---
        function openLibrary() { showLoader(); goBack('page-library'); loadContent('lessons', 'lib-content', 'book', 'Ø§Ù‚Ø±Ø£ Ø§Ù„Ø¯Ø±Ø³'); }
        function openVideos() { showLoader(); goBack('page-videos'); loadContent('videos', 'vid-content', 'play-circle', 'Ø´Ø§Ù‡Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'); }
        function loadContent(coll, elemId, icon, actionTxt){
            const el = document.getElementById(elemId); el.innerHTML='<div class="spinner" style="margin:20px auto;"></div>';
            db.collection(coll).where('grade', 'in', [userData.grade, 'all']).get().then(snap => {
                el.innerHTML='';
                if(snap.empty) { el.innerHTML = '<p style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰</p>'; return; }
                snap.forEach(d => { 
                    const item = d.data(); 
                    let card = document.createElement('div'); card.className = 'lib-item animate__animated animate__fadeIn';
                    card.innerHTML = `<div class="lib-icon"><i class="fas fa-${icon}"></i></div><div><h4>${item.title}</h4><span style="font-size:11px; color:#888;">${item.grade === 'all' ? 'Ø¹Ø§Ù…' : 'Ø®Ø§Øµ Ø¨ØµÙÙƒ'} - ${actionTxt}</span></div>`;
                    card.onclick = () => {
                        if(coll==='videos' && item.url.includes('youtu')) { document.getElementById('view-bod').innerHTML = `<iframe width="100%" height="300" src="https://www.youtube.com/embed/${item.url.split('v=')[1]||item.url.split('/').pop()}" frameborder="0" allowfullscreen></iframe>`; document.getElementById('view-img').style.display='none'; }
                        else if(coll==='videos') { window.open(item.url,'_system'); return; }
                        else { document.getElementById('view-bod').innerText = item.body; const img = document.getElementById('view-img'); if(item.img && item.img.length>5) { img.src=item.img; img.style.display='block'; } else { img.style.display='none'; } }
                        document.getElementById('view-tit').innerText = item.title; document.getElementById('modal-view').style.display = 'flex';
                    };
                    el.appendChild(card);
                });
                hideLoader();
            });
        }
        
        // --- Community ---
        function openComments(){ goBack('page-comments'); loadPubComments(); }
        function loadPubComments(){
            db.collection('public_comments').orderBy('time','desc').limit(20).onSnapshot(s=>{
                document.getElementById('pub-list').innerHTML = s.docs.map(d=>{
                    const c = d.data();
                    return `<div style="background:#fff; padding:10px; border-radius:10px; margin-bottom:10px; border:1px solid #eee;">
                        <div style="font-size:12px; color:var(--main); font-weight:bold;">${c.name}</div>
                        <div>${c.text}</div>
                        ${c.reply?`<div style="background:#f0fdf4; border-right:3px solid #2ecc71; padding:8px; margin-top:8px; font-size:13px; border-radius:8px;"><b>ğŸ‘¨â€ğŸ« Ø±Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…:</b><br>${c.reply}</div>`:''}
                    </div>`;
                }).join('');
            });
        }
        function sendPublicComment(){ const t = document.getElementById('pub-comment').value.trim(); if(!t) return; db.collection('public_comments').add({ name: userData.name, text: t, uid: currentUser ? currentUser.uid : 'guest', time: new Date().toISOString() }); document.getElementById('pub-comment').value=''; }

        // --- Profile & Badges ---
        function openProfile(){ if(userData.isGuest) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹','info'); goBack('page-profile'); loadStats(); loadBadges(); loadPrivateChat(); }
        function toggleEditMode(){ const view = document.getElementById('view-mode'); const edit = document.getElementById('edit-mode'); if(view.style.display !== 'none') { view.style.display = 'none'; edit.style.display = 'block'; document.getElementById('edit-name').value = userData.name; document.getElementById('edit-grade').value = userData.grade; } else { view.style.display = 'block'; edit.style.display = 'none'; } }
        function saveProfileData(){ const n = document.getElementById('edit-name').value; const g = document.getElementById('edit-grade').value; showLoader(); db.collection('users').doc(currentUser.uid).update({name:n, grade:g}).then(()=>{ hideLoader(); toggleEditMode(); Swal.fire('ØªÙ…','','success'); }); }
        function loadStats(){ db.collection('results').where('uid','==',currentUser.uid).get().then(snap=>{ let total=0, sum=0; snap.forEach(d=>{ total++; sum += (d.data().score/d.data().total)*100; }); document.getElementById('st-exams').innerText = total; document.getElementById('st-score').innerText = total>0 ? Math.round(sum/total)+'%' : '0%'; }); }
        function loadBadges(){ 
            const box = document.getElementById('badges-container'); 
            db.collection('user_badges').where('uid','==',currentUser.uid).get().then(snap=>{ 
                if(snap.empty){ box.innerHTML='<p style="grid-column:1/-1; text-align:center; color:#999; font-size:12px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø§Ø±Ø§Øª.</p>'; document.getElementById('st-badges').innerText='0'; return; } 
                box.innerHTML = ''; document.getElementById('st-badges').innerText = snap.size; 
                snap.forEach(doc=>{ const b = doc.data(); box.innerHTML += `<div style="text-align:center; padding:10px;"><i class="${b.icon}" style="color:${b.color||'gold'}; font-size:25px;"></i><span style="display:block; font-size:11px;">${b.title}</span></div>`; }); 
            }); 
        }
        function loadPrivateChat(){ const box = document.getElementById('chat-messages'); db.collection('messages').doc(currentUser.uid).collection('chat').orderBy('timestamp').onSnapshot(snap=>{ box.innerHTML = ''; snap.forEach(d=>{ const m = d.data(); box.innerHTML += `<div style="max-width:80%; padding:8px 12px; border-radius:15px; font-size:13px; align-self:${m.sender === 'student' ? 'flex-start' : 'flex-end'}; background:${m.sender === 'student' ? 'var(--main)' : '#eee'}; color:${m.sender === 'student' ? 'white' : 'black'};">${m.text}</div>`; }); box.scrollTop = box.scrollHeight; }); }
        function sendPrivateMessage(){ const txt = document.getElementById('msg-input').value.trim(); if(!txt) return; const ref = db.collection('messages').doc(currentUser.uid); ref.set({ studentName: userData.name, lastMessage: txt, lastTime: new Date().toISOString(), unread: true, uid: currentUser.uid }, {merge:true}); ref.collection('chat').add({ text: txt, sender: 'student', timestamp: new Date().toISOString() }); document.getElementById('msg-input').value=''; }
        function checkAutoBadges(){ db.collection('badges_rules').where('type','==','auto').get().then(rules=>{ if(rules.empty) return; db.collection('results').where('uid','==',currentUser.uid).get().then(resSnap=>{ const totalExams = resSnap.size; let perfectScores = 0; resSnap.forEach(r=>{ if(r.data().score == r.data().total) perfectScores++; }); rules.forEach(ruleDoc=>{ const rule = ruleDoc.data(); let earned = false; if(rule.condition === 'exams_count' && totalExams >= rule.threshold) earned = true; if(rule.condition === 'perfect_score' && perfectScores >= rule.threshold) earned = true; if(earned){ db.collection('user_badges').where('uid','==',currentUser.uid).where('badgeId','==',ruleDoc.id).get().then(bCheck=>{ if(bCheck.empty){ db.collection('user_badges').add({ uid: currentUser.uid, badgeId: ruleDoc.id, title: rule.title, icon: rule.icon, color: rule.color, timestamp: new Date().toISOString() }); Swal.fire({ title: 'Ø£Ù„Ù Ù…Ø¨Ø±ÙˆÙƒ! ğŸ†', text: `Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø´Ø§Ø±Ø©: ${rule.title}`, backdrop: `rgba(0,0,123,0.4)` }); } }); } }); }); }); }
    </script> 
  </div> 
 
</body></html>